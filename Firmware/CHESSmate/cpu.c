/** CHESSmate emulator for Arduino.
 *  
 *  Most of this is the 6502 emulator from Mike Chambers.
 *  
 *    http://forum.arduino.cc/index.php?topic=193216.0
 *    
 *  Project inspired by Oscar Vermeulen's KIM-1 Uno project.
 *  
 *    https://obsolescence.wixsite.com/obsolescence/kim-uno-summary-c1uuh
 *    
 *  CHESSmate code added by Michael Gardi.
 * 
 *    https://hackaday.io/project/194011-commodore-chessmate-reproduction
 *    
 */

#include <stdint.h>
#include <avr/pgmspace.h>

extern void printhex(uint16_t val);
extern void serout(uint8_t value);
extern uint8_t readRRIOT(uint16_t address);
extern void writeRRIOT(uint16_t address, uint8_t value);

#define NULL (void *) 0

#define CHESSMATE_ROM 0xF000
#define RRIOT_REGISTERS 0x8B00
#define RRIOT_RAM_ADDR 0x8B80

#define RAM_SIZE 1536
#define ROM_SIZE 4096
#define RRIOT_REG_SIZE 12
#define RRIOT_RAM_SIZE 64

//6502 defines
//#define UNDOCUMENTED //when this is defined, undocumented opcodes are handled.
                     //otherwise, they're simply treated as NOPs.

//#define USE_TIMING //slower, but allows you to specify number of cycles to run for exec6502
                   //rather than simply a number of instructions. also uses a little more
                   //program memory when enabled.

#define FLAG_CARRY     0x01
#define FLAG_ZERO      0x02
#define FLAG_INTERRUPT 0x04
#define FLAG_DECIMAL   0x08
#define FLAG_BREAK     0x10
#define FLAG_CONSTANT  0x20
#define FLAG_OVERFLOW  0x40
#define FLAG_SIGN      0x80

#define BASE_STACK     0x100

#define saveaccum(n) a = (uint8_t)((n) & 0x00FF)


//flag modifier macros
#define setcarry() cpustatus |= FLAG_CARRY
#define clearcarry() cpustatus &= (~FLAG_CARRY)
#define setzero() cpustatus |= FLAG_ZERO
#define clearzero() cpustatus &= (~FLAG_ZERO)
#define setinterrupt() cpustatus |= FLAG_INTERRUPT
#define clearinterrupt() cpustatus &= (~FLAG_INTERRUPT)
#define setdecimal() cpustatus |= FLAG_DECIMAL
#define cleardecimal() cpustatus &= (~FLAG_DECIMAL)
#define setoverflow() cpustatus |= FLAG_OVERFLOW
#define clearoverflow() cpustatus &= (~FLAG_OVERFLOW)
#define setsign() cpustatus |= FLAG_SIGN
#define clearsign() cpustatus &= (~FLAG_SIGN)


//flag calculation macros
#define zerocalc(n) { if ((n) & 0x00FF) clearzero(); else setzero(); }

#define signcalc(n) { if ((n) & 0x0080) setsign(); else clearsign(); }

#define carrycalc(n) { if ((n) & 0xFF00) setcarry(); else clearcarry(); }

#define overflowcalc(n, m, o) { if (((n) ^ (uint16_t)(m)) & ((n) ^ (o)) & 0x0080) setoverflow(); else clearoverflow(); }


//6502 CPU registers
uint16_t pc;
uint8_t sp, a, x, y, cpustatus;


//helper variables
uint32_t instructions = 0; //keep track of total instructions executed
int32_t clockticks6502 = 0, clockgoal6502 = 0;
uint16_t oldpc, ea, reladdr, value, result;
uint8_t opcode, oldcpustatus, useaccum;

uint8_t RAM[RAM_SIZE];

PGM_P const CHESSMATE[ROM_SIZE] PROGMEM = {
	0xd8,0x58,0xa2,0xfe,0x9a,0xa9,0x3f,0x8d,0x03,0x8b,0xa9,0xff,0xa2,0x00,0x95,0x00,
	0xd5,0x00,0xf0,0x05,0xb5,0x00,0x4c,0x14,0xf0,0xca,0xd0,0xf2,0x49,0xff,0xf0,0xee,
	0xa9,0x05,0x85,0x53,0xa2,0x21,0xbd,0x52,0xfe,0x95,0x00,0xca,0x10,0xf8,0x86,0x59,
	0x20,0xf0,0xf2,0xa9,0x70,0x85,0x56,0xa9,0x20,0x20,0x9c,0xff,0x38,0xe9,0x04,0xd0,
	0xf8,0xa2,0x04,0x4c,0x60,0xf2,0xa9,0xee,0x85,0x83,0x85,0x84,0xd8,0xa2,0xfe,0x9a,
	0xa2,0xb8,0x86,0x61,0xa5,0x78,0x29,0x88,0x24,0x56,0x70,0x02,0x09,0x10,0x85,0x78,
	0xa2,0x00,0x38,0x20,0x04,0xff,0xc9,0x0a,0xd0,0x03,0x4c,0xb9,0xf0,0xc9,0x09,0xf0,
	0xd5,0xe0,0x04,0x30,0x02,0xa2,0x00,0xe0,0x00,0xd0,0x04,0x86,0x83,0x86,0x84,0x20,
	0x85,0xf0,0x4c,0x62,0xf0,0xe0,0x03,0xf0,0x16,0xe0,0x02,0xf0,0x0e,0xe0,0x01,0xf0,
	0x04,0x0a,0x0a,0x0a,0x0a,0x05,0x83,0x85,0x83,0xe8,0x60,0x0a,0x0a,0x0a,0x0a,0x05,
	0x84,0x85,0x84,0xe8,0x60,0xa9,0x00,0x85,0x7c,0x85,0x7d,0x85,0x7e,0xa9,0xf5,0x8d,
	0x0f,0x8b,0xa9,0xf1,0x85,0x7a,0x85,0x7b,0x60,0xe0,0x04,0xf0,0x0a,0xe0,0x00,0xd0,
	0x03,0x4c,0x46,0xf0,0x4c,0xc4,0xf1,0xa5,0x60,0xd0,0x04,0x24,0x56,0x50,0x44,0xa5,
	0x83,0x20,0xd1,0xf2,0x85,0x83,0xa5,0x84,0x20,0xd1,0xf2,0x85,0x84,0xa9,0x00,0x85,
	0x57,0xa5,0x86,0x48,0xa9,0x04,0x85,0x86,0xa2,0x03,0x86,0x24,0x20,0xf0,0xf2,0x20,
	0x7b,0xf6,0x20,0xf0,0xf2,0x68,0x85,0x86,0xa5,0x84,0x49,0x77,0x85,0x84,0x85,0x23,
	0x85,0x72,0xa5,0x83,0x49,0x77,0x85,0x83,0x85,0x71,0xa2,0x11,0xd5,0x11,0xf0,0x06,
	0xca,0x10,0xf9,0x4c,0xd9,0xf2,0x8a,0x18,0x69,0x11,0x85,0x22,0xc6,0x57,0xd0,0x29,
	0x20,0xce,0xf7,0xa6,0x22,0xe0,0x1a,0x30,0x17,0xa5,0x23,0x29,0xf0,0xd0,0x11,0xa9,
	0xcc,0x95,0x00,0xa2,0x12,0xb5,0x00,0x30,0x03,0xe8,0xd0,0xf9,0xa5,0x23,0x95,0x00,
	0xa5,0x78,0x29,0x10,0x85,0x78,0x4c,0x81,0xf3,0xa6,0x22,0xe0,0x11,0xd0,0x4e,0xa6,
	0x5a,0xd0,0x6e,0x24,0x56,0x50,0x22,0xa5,0x83,0xc9,0x74,0xd0,0x64,0xa5,0x84,0xc9,
	0x76,0xd0,0x09,0x20,0xce,0xf7,0xa9,0x75,0x85,0x14,0xd0,0x2d,0xc9,0x72,0xd0,0x51,
	0x20,0xce,0xf7,0xa9,0x73,0x85,0x15,0xd0,0x20,0xa5,0x83,0xc9,0x73,0xd0,0x42,0xa5,
	0x84,0xc9,0x71,0xd0,0x09,0x20,0xce,0xf7,0xa9,0x72,0x85,0x14,0xd0,0x0b,0xc9,0x75,
	0xd0,0x2f,0x20,0xce,0xf7,0xa9,0x74,0x85,0x15,0x85,0x5a,0xd0,0xa9,0xe0,0x1a,0x30,
	0x20,0xa5,0x5f,0xc5,0x84,0xd0,0x1a,0x18,0x69,0x10,0x85,0x23,0xb5,0x00,0x29,0xf0,
	0xc9,0x30,0xd0,0x0d,0x20,0xce,0xf7,0xa5,0x84,0x85,0x23,0x20,0xce,0xf7,0x4c,0x81,
	0xf3,0x4c,0xd9,0xf2,0xa5,0x83,0x29,0xf0,0xc9,0x10,0xd0,0x12,0x24,0x56,0x70,0x0b,
	0x20,0xf0,0xf2,0xa9,0x70,0xa2,0x00,0x85,0x56,0x86,0x7e,0x4c,0x46,0xf0,0xc9,0x80,
	0xd0,0x0d,0x24,0x56,0x50,0xf5,0x20,0xf0,0xf2,0xa9,0x07,0xa2,0x01,0xd0,0xe8,0xc9,
	0x70,0xd0,0x03,0x4c,0x81,0xf3,0xc9,0x20,0xd0,0x51,0xa2,0x02,0xa0,0x21,0xb9,0x94,
	0xfe,0x85,0x83,0xb9,0x00,0x00,0x30,0x26,0x20,0xd9,0xf5,0x85,0x84,0x20,0x04,0xff,
	0xc9,0x0a,0xd0,0x22,0xa2,0xf0,0x86,0x74,0xa2,0x02,0x86,0x59,0xa5,0x84,0xf0,0x12,
	0x20,0xd1,0xf2,0x49,0x77,0x99,0x00,0x00,0x88,0x10,0xd3,0x4c,0x46,0xf0,0xa9,0x00,
	0xf0,0xd9,0xa9,0xcc,0xd0,0xef,0xe0,0x02,0xd0,0x06,0x48,0xa9,0x00,0x85,0x84,0x68,
	0x20,0x85,0xf0,0xe0,0x04,0x30,0xc6,0xa2,0x02,0xd0,0xc2,0xc9,0x60,0xd0,0x30,0xe0,
	0x02,0xf0,0x08,0xa6,0x89,0xe8,0x86,0x84,0x4c,0x4c,0xf0,0xa5,0x83,0x29,0x0f,0xaa,
	0xca,0x10,0x03,0x4c,0xd9,0xf2,0xbd,0x74,0xfe,0x86,0x89,0x85,0x85,0xbd,0x7c,0xfe,
	0x85,0x86,0xbd,0x84,0xfe,0x85,0x87,0xbd,0x8c,0xfe,0x85,0x88,0x4c,0x46,0xf0,0xc9,
	0x50,0xd0,0x06,0x20,0xc4,0xf2,0x4c,0x46,0xf0,0xc9,0x40,0xd0,0x05,0x20,0x02,0xff,
	0xd0,0xf4,0xc9,0x30,0xd0,0x38,0x20,0xa5,0xf0,0xd0,0x23,0x20,0x02,0xff,0xc9,0x08,
	0xd0,0x0a,0xa9,0x10,0x85,0x78,0xa9,0x00,0x85,0x7e,0xf0,0xef,0xc9,0x01,0xd0,0x0a,
	0xa9,0x01,0x85,0x7e,0xa9,0x00,0x85,0x78,0xf0,0xe1,0xc9,0x05,0xd0,0xbe,0x20,0xc4,
	0xf2,0x4c,0x9e,0xf2,0xae,0x06,0x8b,0x20,0x02,0xff,0x8e,0x0f,0x8b,0x60,0x4c,0xd9,
	0xf2,0x38,0xe9,0x11,0x45,0x56,0x4c,0xde,0xf5,0xa9,0x0a,0x85,0x83,0x85,0x84,0xc6,
	0x8b,0x20,0x9a,0xff,0x20,0x34,0xff,0x46,0x8b,0xd0,0xf6,0xa2,0x00,0x4c,0x62,0xf0,
	0xa2,0x10,0xb4,0x11,0xb5,0x00,0x49,0x77,0x95,0x11,0x98,0x49,0x77,0x95,0x00,0xca,
	0x10,0xf0,0x60,0xb1,0x76,0x48,0xc8,0xb1,0x76,0x85,0x2a,0x68,0xa2,0x11,0xd5,0x00,
	0xf0,0x06,0xca,0x10,0xf9,0x4c,0x2b,0xf4,0x86,0x29,0xe0,0x00,0xd0,0x2b,0xa5,0x2a,
	0xa2,0x03,0xc9,0x06,0xd0,0x06,0xa9,0x05,0x95,0x00,0xd0,0x1d,0xc9,0x01,0xd0,0x06,
	0xa9,0x02,0x95,0x00,0xd0,0x13,0xe8,0xc9,0x02,0xd0,0x06,0xa9,0x03,0x95,0x00,0xd0,
	0x08,0xc9,0x05,0xd0,0x04,0xa9,0x04,0x95,0x00,0x4c,0x14,0xf5,0x48,0x8a,0x48,0x98,
	0x48,0xa9,0x5d,0x8d,0x04,0x8b,0x2c,0x07,0x8b,0x10,0xfb,0xa6,0x7e,0xd6,0x7a,0xd0,
	0x12,0xa9,0xf0,0x95,0x7a,0xf8,0x18,0xb5,0x7c,0x69,0x01,0xc9,0x60,0xd0,0x02,0xa9,
	0x00,0x95,0x7c,0xa9,0xf4,0x8d,0x0f,0x8b,0x68,0xa8,0x68,0xaa,0x68,0x40,0x4c,0xd9,
	0xf2,0xa5,0x00,0x30,0xf9,0xa5,0x11,0x30,0xf5,0xa9,0x00,0x85,0x5f,0xad,0x0e,0x8b,
	0x85,0x38,0xa9,0x00,0x24,0x56,0x50,0x02,0xa9,0x01,0x85,0x7e,0xa5,0x22,0xc9,0x1a,
	0x30,0x10,0xa5,0x71,0x38,0xe5,0x72,0xc9,0x20,0xd0,0x07,0xa5,0x72,0x18,0x69,0x10,
	0x85,0x5f,0xa4,0x75,0xd0,0x11,0xa5,0x74,0x30,0x03,0x20,0xa5,0xf0,0x24,0x56,0x50,
	0x14,0xa5,0x71,0x05,0x72,0xf0,0xb7,0xa5,0x71,0x49,0x77,0x20,0xed,0xf5,0xa5,0x72,
	0x49,0x77,0x20,0xed,0xf5,0xa5,0x74,0x30,0x56,0xa9,0x00,0x85,0x74,0xa5,0x38,0x29,
	0x03,0x09,0x8c,0x85,0x77,0xa5,0x38,0x29,0x1c,0x0a,0x0a,0x0a,0x85,0x76,0xa0,0x00,
	0xc4,0x75,0xf0,0x0c,0xb9,0x80,0x8b,0xd1,0x76,0xd0,0x08,0xc8,0xc4,0x75,0xd0,0xf4,
	0x4c,0x03,0xf3,0xa5,0x76,0x18,0x69,0x20,0x85,0x76,0xa5,0x77,0x69,0x00,0x85,0x77,
	0xa5,0x76,0xc9,0xe1,0xa5,0x77,0xe9,0x8f,0x90,0xd4,0xa5,0x74,0xd0,0x0d,0xe6,0x74,
	0xa9,0x8c,0x85,0x77,0xa9,0x00,0x85,0x76,0x4c,0xee,0xf3,0xa9,0xf0,0x85,0x74,0xa2,
	0x0c,0x86,0x24,0x86,0x28,0x86,0x27,0xa2,0x14,0x20,0x74,0xf6,0xa2,0x04,0x86,0x24,
	0xa9,0xff,0xa2,0x05,0x95,0x6a,0xca,0x10,0xfb,0x85,0x81,0x20,0x72,0xf6,0xa5,0x78,
	0x29,0xf7,0xa6,0x79,0xec,0x30,0xfe,0xf0,0x02,0xd0,0x02,0x09,0x08,0x85,0x78,0xa6,
	0x27,0xe0,0x0f,0xb0,0x23,0xa9,0x00,0x20,0x00,0xf6,0xa5,0x47,0x30,0x0f,0xa5,0x78,
	0x09,0x80,0x85,0x78,0xa5,0x8b,0x20,0x9f,0xff,0xc6,0x8b,0xd0,0xf7,0xa9,0x00,0x85,
	0x29,0xa5,0x00,0x85,0x2a,0x4c,0x14,0xf5,0xa5,0x78,0x29,0x7f,0x85,0x78,0xa5,0x27,
	0xc9,0x82,0x10,0x06,0xc9,0x80,0x30,0x7c,0xa5,0x59,0x10,0x78,0xa5,0x6f,0x30,0x36,
	0xa5,0x6e,0x30,0x32,0xa5,0x00,0xc9,0x03,0xf0,0x17,0xa5,0x6a,0x30,0x28,0x85,0x23,
	0xa9,0x04,0x85,0x22,0x20,0xce,0xf7,0xa9,0x00,0x85,0x29,0xa9,0x02,0x85,0x2a,0xd0,
	0x4d,0xa9,0x03,0x85,0x22,0xa9,0x02,0x85,0x23,0x20,0xce,0xf7,0xa9,0x00,0x85,0x29,
	0xa9,0x01,0x85,0x2a,0xd0,0x38,0xa5,0x6d,0x30,0x3a,0xa5,0x6c,0x30,0x36,0xa5,0x00,
	0xc9,0x04,0xf0,0x17,0xa5,0x6b,0x30,0x2c,0x85,0x23,0xa9,0x04,0x85,0x22,0x20,0xce,
	0xf7,0xa9,0x00,0x85,0x29,0xa9,0x05,0x85,0x2a,0xd0,0x13,0xa9,0x05,0x85,0x23,0xa9,
	0x03,0x85,0x22,0x20,0xce,0xf7,0xa9,0x00,0x85,0x29,0xa9,0x06,0x85,0x2a,0xa5,0x78,
	0x29,0xf7,0x85,0x78,0xa6,0x29,0xd0,0x02,0x86,0x59,0xb5,0x00,0x85,0x28,0x86,0x22,
	0xa5,0x2a,0x85,0x23,0xe0,0x09,0x30,0x24,0xc5,0x5f,0xd0,0x0c,0x48,0x38,0xe9,0x10,
	0x85,0x23,0x20,0xce,0xf7,0x68,0x85,0x23,0xa9,0xac,0x85,0x5f,0xa5,0x23,0x38,0xf5,
	0x00,0xc9,0x20,0xd0,0x07,0xa5,0x23,0x38,0xe9,0x10,0x85,0x5f,0x20,0xce,0xf7,0xa5,
	0x5d,0x85,0x5e,0xa5,0x29,0x85,0x5d,0xa5,0x5b,0x85,0x5c,0xa5,0x2a,0x85,0x5b,0xe6,
	0x60,0xa6,0x29,0xe0,0x09,0x30,0x19,0xa5,0x2a,0x29,0x70,0xc9,0x70,0xd0,0x11,0xa9,
	0xcc,0x95,0x00,0xa2,0x00,0xb5,0x00,0x30,0x03,0xe8,0xd0,0xf9,0xa5,0x2a,0x95,0x00,
	0xa9,0x00,0x85,0x84,0xa5,0x28,0x20,0xed,0xf5,0x20,0xd9,0xf5,0x85,0x83,0x20,0x26,
	0xff,0xa5,0x2a,0x20,0xed,0xf5,0x20,0xd9,0xf5,0x85,0x84,0x20,0x26,0xff,0xa9,0x00,
	0x24,0x56,0x70,0x02,0xa9,0x01,0x85,0x7e,0xa5,0x78,0x29,0x08,0xf0,0x28,0xc6,0x8b,
	0x20,0x95,0xff,0x46,0x8b,0xd0,0xf9,0xa5,0x86,0x48,0x85,0x3c,0xa2,0x0c,0x86,0x24,
	0xe8,0x86,0x86,0x20,0xa8,0xf7,0x68,0x85,0x86,0xc5,0x3c,0xd0,0x09,0xa2,0x20,0x8a,
	0x20,0x17,0xff,0xca,0xd0,0xf9,0x4c,0x4c,0xf0,0x45,0x56,0x18,0x69,0x11,0x48,0x4a,
	0x4a,0x4a,0x4a,0x85,0x69,0x68,0x0a,0x0a,0x0a,0x0a,0x05,0x69,0x60,0xa4,0x75,0x99,
	0x80,0x8b,0xc8,0xc0,0x20,0x30,0x06,0xa0,0xf0,0x84,0x74,0xa0,0x00,0x84,0x75,0x60,
	0x85,0x22,0x20,0xa1,0xf7,0xa9,0xf8,0x85,0x24,0x85,0x47,0xa2,0x10,0x86,0x48,0x20,
	0x1a,0xf7,0xd0,0xfb,0xa5,0x47,0x10,0x0d,0xa9,0xf9,0x85,0x24,0xa9,0x08,0x85,0x48,
	0x20,0x2a,0xf7,0xd0,0xfb,0x60,0xe0,0xf9,0xf0,0x26,0xa6,0x70,0xa5,0x48,0xc9,0x09,
	0x10,0x11,0xe0,0x11,0xf0,0x15,0xe0,0x1a,0x30,0x08,0xc9,0x06,0xf0,0x0d,0xc9,0x05,
	0xf0,0x09,0x60,0xe0,0x18,0xf0,0x04,0xe0,0x19,0xd0,0x1d,0xa9,0x00,0x85,0x47,0x60,
	0xa5,0x48,0xa6,0x70,0xe0,0x12,0xf0,0xf3,0xe0,0x13,0xf0,0xef,0xc9,0x05,0x10,0x09,
	0xe0,0x14,0xf0,0xe7,0xe0,0x15,0xf0,0xe3,0x60,0xe0,0x16,0xf0,0xde,0xe0,0x17,0xf0,
	0xda,0x60,0xa2,0x10,0xa9,0x00,0x95,0x2b,0xca,0x10,0xfb,0xa9,0x11,0x85,0x22,0xc6,
	0x22,0x10,0x01,0x60,0x20,0xa1,0xf7,0xa4,0x22,0xa2,0x08,0x86,0x48,0xc0,0x09,0x10,
	0x45,0xc0,0x07,0x10,0x32,0xc0,0x05,0x10,0x23,0xc0,0x02,0xf0,0x0d,0x10,0x12,0xc0,
	0x01,0xf0,0x07,0x20,0x1a,0xf7,0xd0,0xfb,0xf0,0xd5,0x20,0x2a,0xf7,0xd0,0xfb,0xf0,
	0xce,0xa2,0x04,0x86,0x48,0x20,0x2a,0xf7,0xd0,0xfb,0xf0,0xc3,0x20,0x2a,0xf7,0xa5,
	0x48,0xc9,0x04,0xd0,0xf7,0xf0,0xb8,0xa2,0x10,0x86,0x48,0x20,0x1a,0xf7,0xa5,0x48,
	0xc9,0x08,0xd0,0xf7,0xf0,0xa9,0x20,0xdc,0xf6,0x4c,0x7f,0xf6,0xa2,0x06,0x86,0x48,
	0x20,0x40,0xf7,0x30,0x13,0x70,0x0c,0xa6,0x24,0xe0,0x04,0xd0,0x0b,0xa5,0x23,0xc5,
	0x5f,0xd0,0x05,0x08,0x20,0xfa,0xf7,0x28,0x20,0xa1,0xf7,0xc6,0x48,0xa5,0x48,0xc9,
	0x05,0xf0,0xdd,0x20,0x40,0xf7,0x70,0x11,0xb0,0x07,0x30,0x0d,0x08,0x20,0xfa,0xf7,
	0x28,0xa5,0x23,0x29,0xf0,0xc9,0x20,0xf0,0xea,0x60,0x20,0x40,0xf7,0x30,0x05,0x08,
	0x20,0xfa,0xf7,0x28,0x20,0xa1,0xf7,0xc6,0x48,0x60,0x20,0x40,0xf7,0x90,0x02,0x50,
	0xf9,0x30,0x07,0x08,0x20,0xfa,0xf7,0x28,0x50,0xf0,0x20,0xa1,0xf7,0xc6,0x48,0x60,
	0xa5,0x23,0xa6,0x48,0x18,0x7d,0x41,0xfe,0x85,0x23,0x29,0x88,0xd0,0x4e,0xa5,0x23,
	0xa2,0x22,0xca,0x30,0x10,0xd5,0x00,0xd0,0xf9,0xe0,0x11,0x30,0x36,0x86,0x70,0xa9,
	0x7f,0x69,0x01,0x70,0x01,0xb8,0xa5,0x24,0xc5,0x85,0x30,0x23,0xc5,0x86,0x10,0x1f,
	0x48,0x08,0xa5,0x70,0x48,0x20,0xce,0xf7,0xa9,0x00,0x20,0x00,0xf6,0x20,0xb4,0xf7,
	0x68,0x85,0x70,0x28,0x68,0x85,0x24,0xa5,0x47,0x30,0x04,0x38,0xa9,0xff,0x60,0x18,
	0xa9,0x00,0x60,0x8a,0xa6,0x24,0xe0,0x04,0x30,0x02,0xf6,0x33,0xa9,0xff,0x18,0xb8,
	0x60,0xa6,0x22,0xb5,0x00,0x85,0x23,0x60,0x20,0xce,0xf7,0x20,0xf0,0xf2,0x20,0x7b,
	0xf6,0x20,0xf0,0xf2,0xba,0x86,0x49,0xa6,0x61,0x9a,0x68,0x85,0x48,0x68,0x85,0x22,
	0xaa,0x68,0x95,0x00,0x68,0xaa,0x68,0x85,0x23,0x95,0x00,0x4c,0xf3,0xf7,0xba,0x86,
	0x49,0xa6,0x61,0x9a,0xa5,0x23,0x48,0xa8,0xa2,0x21,0xd5,0x00,0xf0,0x03,0xca,0x10,
	0xf9,0xa9,0xcc,0x95,0x00,0x8a,0x48,0xa6,0x22,0xb5,0x00,0x94,0x00,0x48,0x8a,0x48,
	0xa5,0x48,0x48,0xba,0x86,0x61,0xa6,0x49,0x9a,0x60,0xa6,0x24,0xe0,0x03,0xd0,0x11,
	0xa5,0x23,0xc5,0x84,0xd0,0x0a,0xa6,0x22,0xb5,0x00,0xc5,0x83,0xd0,0x02,0xe6,0x57,
	0x60,0xe0,0x05,0xd0,0x12,0x86,0x4a,0xe6,0x24,0x20,0xa8,0xf7,0xc6,0x24,0xa5,0x4a,
	0xc5,0x4c,0x30,0x34,0x85,0x4c,0x60,0xe0,0x06,0xd0,0x2e,0xa9,0xff,0x85,0x4b,0xe6,
	0x24,0x20,0xa8,0xf7,0xc6,0x24,0xa5,0x4b,0x10,0x1e,0x20,0xce,0xf7,0xa9,0x08,0x85,
	0x24,0x85,0x39,0x20,0x7b,0xf6,0x20,0xb4,0xf7,0xa9,0x06,0x85,0x24,0xa5,0x39,0xcd,
	0x30,0xfe,0xd0,0x04,0xa9,0xff,0x85,0x4a,0x60,0xe0,0x07,0xd0,0x08,0xe6,0x4b,0x68,
	0x68,0x68,0x68,0x68,0x60,0xe0,0xff,0xf0,0x67,0x10,0x03,0x4c,0xf6,0xf8,0xf6,0x30,
	0xa5,0x22,0xc9,0x02,0xf0,0x04,0xc9,0x01,0xd0,0x02,0xf6,0x30,0x50,0x12,0xa4,0x70,
	0xb9,0x1f,0xfe,0xd5,0x31,0x90,0x02,0x95,0x31,0x18,0x08,0x75,0x32,0x95,0x32,0x28,
	0xe0,0x04,0xf0,0x1b,0x30,0x01,0x60,0xa5,0x22,0xc9,0x09,0x30,0x10,0xa5,0x23,0x29,
	0x70,0xc9,0x70,0xd0,0x08,0xa5,0x22,0x85,0x81,0xa5,0x23,0x85,0x82,0xd0,0x54,0xa5,
	0x35,0x85,0x40,0xa9,0x00,0x85,0x24,0x20,0xce,0xf7,0x20,0xf0,0xf2,0x20,0x72,0xf6,
	0x20,0xf0,0xf2,0xa9,0x08,0x85,0x24,0x20,0x7b,0xf6,0x20,0xb4,0xf7,0x4c,0x9c,0xf9,
	0xa9,0x00,0x85,0x4f,0xe6,0x54,0xd0,0x10,0xa5,0x22,0xc9,0x03,0x30,0x0d,0xa4,0x52,
	0xd0,0x06,0x68,0x68,0x68,0x68,0x68,0x60,0x70,0x19,0x60,0xa9,0x80,0x70,0x14,0x85,
	0x51,0xa9,0x00,0xc8,0x50,0x35,0xe0,0xf9,0xf0,0x04,0xe0,0xf8,0xd0,0x05,0x50,0xea,
	0x4c,0x26,0xf6,0xa4,0x70,0xe4,0x88,0xd0,0x04,0x50,0x0a,0x70,0x1b,0x50,0xdb,0xc0,
	0x1a,0x10,0xd7,0x30,0x13,0xa5,0x89,0xc9,0x07,0xd0,0xcf,0xa5,0x11,0x38,0xe9,0x10,
	0x29,0x70,0xc5,0x23,0xb0,0xc4,0xa0,0x10,0xb9,0x1f,0xfe,0x95,0x2f,0x85,0x52,0xe0,
	0xfe,0xd0,0x05,0x18,0x65,0x4f,0x85,0x4f,0xc6,0x24,0xc0,0x11,0xf0,0x37,0xa6,0x87,
	0xe4,0x24,0xf0,0x31,0xa6,0x24,0xe0,0xff,0xd0,0x05,0x86,0x54,0xe8,0x86,0x51,0x20,
	0xa8,0xf7,0xa6,0x24,0xe0,0xfe,0xd0,0x0c,0xa5,0x51,0x10,0x19,0xa5,0x4f,0xc5,0x50,
	0x90,0x02,0x85,0x50,0xe0,0xff,0xd0,0x0d,0xa5,0x51,0x10,0x02,0x85,0x8a,0xa6,0x54,
	0x10,0x03,0xe8,0x86,0x53,0xe6,0x24,0xa5,0x24,0xaa,0x4a,0x90,0x0f,0x18,0xb5,0x2f,
	0x75,0x45,0xd5,0x46,0x30,0x02,0x95,0x46,0xa9,0x00,0xf0,0x0d,0x38,0xb5,0x45,0xf5,
	0x2f,0xd5,0x46,0x10,0x02,0x95,0x46,0xa9,0x00,0x95,0x45,0x60,0xa6,0x31,0xec,0x30,
	0xfe,0xd0,0x07,0xa9,0x00,0x85,0x25,0x4c,0x8b,0xfd,0xa6,0x30,0xd0,0x0e,0xa6,0x39,
	0xec,0x30,0xfe,0xd0,0x07,0xa9,0xff,0x85,0x25,0x4c,0x8b,0xfd,0xa5,0x22,0xc9,0x09,
	0x30,0x0a,0xa5,0x23,0xc5,0x5f,0xd0,0x04,0xa9,0x01,0x85,0x40,0xa5,0x40,0x18,0x69,
	0x40,0x65,0x46,0x0a,0x85,0x25,0xa5,0x53,0xd0,0x04,0xa9,0x10,0x85,0x25,0xa9,0x20,
	0x18,0x65,0x3a,0x65,0x40,0x38,0xe5,0x3e,0xa6,0x22,0xfd,0x30,0xfe,0x0a,0x85,0x26,
	0xa9,0x28,0x18,0x65,0x3a,0x65,0x39,0xa6,0x22,0x7d,0x30,0xfe,0x38,0xe5,0x32,0xe5,
	0x31,0xe5,0x31,0x90,0x03,0x20,0xcd,0xfd,0xa9,0x50,0x18,0x65,0x38,0x38,0xe5,0x3c,
	0xe5,0x30,0x90,0x04,0x4a,0x20,0xcd,0xfd,0xa9,0x10,0x65,0x3b,0x38,0xe5,0x3f,0x20,
	0xcd,0xfd,0xa5,0x8a,0x10,0x05,0xa9,0x38,0x20,0xd9,0xfd,0xa5,0x50,0xf0,0x0a,0xc6,
	0x25,0xc9,0x07,0x30,0x04,0xc6,0x25,0xc6,0x25,0xa5,0x22,0xc5,0x5e,0xf0,0x06,0xc5,
	0x5d,0xd0,0x12,0xf0,0x0b,0xa5,0x23,0xc5,0x5c,0xd0,0x05,0xa9,0x20,0x20,0xd9,0xfd,
	0xa9,0x10,0x20,0xd9,0xfd,0xa9,0x00,0x18,0xa2,0x10,0xb4,0x00,0x30,0x03,0x7d,0x30,
	0xfe,0xca,0x10,0xf6,0xa2,0x10,0x38,0xb4,0x11,0x30,0x03,0xfd,0x30,0xfe,0xca,0x10,
	0xf6,0xc9,0xf5,0x30,0x73,0x48,0xa6,0x22,0xb5,0x00,0xa2,0x03,0x20,0xf7,0xfa,0xd0,
	0x50,0xa2,0x08,0x20,0xf7,0xfa,0xd0,0x49,0xa2,0x0b,0x20,0xf7,0xfa,0xd0,0x42,0xa5,
	0x23,0xa2,0x04,0x20,0xf7,0xfa,0xd0,0x39,0xa2,0x07,0x20,0xf7,0xfa,0xd0,0x32,0xa2,
	0x0c,0x20,0xf7,0xfa,0xd0,0x2b,0xa5,0x71,0x49,0x77,0xa2,0x05,0x20,0xf7,0xfa,0xd0,
	0x20,0xa2,0x0a,0x20,0xf7,0xfa,0xd0,0x19,0xa5,0x72,0x49,0x77,0xa2,0x06,0x20,0xf7,
	0xfa,0xd0,0x0e,0xa2,0x09,0x20,0xf7,0xfa,0xd0,0x07,0xa5,0x25,0x38,0xe9,0x06,0x85,
	0x25,0x68,0xc9,0x00,0x30,0x12,0xa5,0x40,0xf0,0x2b,0xa5,0x25,0xc9,0x80,0x30,0x25,
	0xa9,0x18,0x20,0xcd,0xfd,0x4c,0x05,0xfb,0xa6,0x30,0xd0,0x19,0xc9,0xf6,0x30,0x15,
	0xa9,0x90,0x85,0x25,0x4c,0x8b,0xfd,0xa4,0x75,0x88,0x10,0x02,0xa0,0x1f,0xca,0xd0,
	0xf8,0xd9,0x80,0x8b,0x60,0xa6,0x22,0xf0,0x11,0xb5,0x00,0x29,0x70,0xd0,0x0b,0xa5,
	0x23,0x29,0x70,0xf0,0x05,0xa9,0x30,0x20,0xcd,0xfd,0xa5,0x81,0x30,0x34,0x20,0xce,
	0xf7,0xa5,0x70,0x48,0x20,0xf0,0xf2,0xa6,0x81,0xb5,0x00,0x48,0xa5,0x82,0x95,0x00,
	0x8a,0x20,0x00,0xf6,0xa6,0x81,0x68,0x95,0x00,0x20,0xf0,0xf2,0x68,0x85,0x70,0x20,
	0xb4,0xf7,0xa5,0x47,0x10,0x07,0xa5,0x25,0x38,0xe9,0x0a,0x85,0x25,0xa9,0x50,0x20,
	0xd9,0xfd,0xa5,0x3a,0x38,0xe5,0x3e,0xc9,0x10,0x30,0x14,0x48,0xa9,0x10,0x20,0xcd,
	0xfd,0x68,0x38,0xa6,0x22,0xfd,0x30,0xfe,0x30,0x05,0xa9,0x10,0x20,0xcd,0xfd,0xa5,
	0x23,0xc5,0x72,0xd0,0x05,0xa9,0x38,0x20,0xcd,0xfd,0xa6,0x22,0xe0,0x09,0x10,0x03,
	0x4c,0x06,0xfc,0x38,0xa5,0x23,0xf5,0x00,0xc9,0x20,0xd0,0x23,0xa5,0x23,0x18,0x69,
	0x01,0xa2,0x08,0xd5,0x1a,0xf0,0x11,0xca,0x10,0xf9,0x38,0xe9,0x02,0xa2,0x08,0xd5,
	0x1a,0xf0,0x05,0xca,0x10,0xf9,0x30,0x07,0xa5,0x25,0x38,0xe9,0x03,0x85,0x25,0xa6,
	0x22,0xb5,0x00,0xc9,0x13,0xf0,0x04,0xc9,0x14,0xd0,0x05,0xa9,0x20,0x20,0xcd,0xfd,
	0xa5,0x23,0xc9,0x33,0xf0,0x3b,0xc9,0x34,0xf0,0x37,0xc9,0x43,0xf0,0x33,0xc9,0x44,
	0xf0,0x2f,0xa6,0x46,0xd0,0x30,0x29,0x70,0xc9,0x70,0xf0,0x0a,0xc9,0x60,0xf0,0x1c,
	0xc9,0x50,0xf0,0x1d,0xd0,0x20,0x20,0xce,0xf7,0xa5,0x22,0x20,0x00,0xf6,0x20,0xb4,
	0xf7,0xa5,0x47,0x10,0x11,0xa5,0x25,0x18,0x69,0x10,0x85,0x25,0xa9,0x10,0x20,0xcd,
	0xfd,0xa9,0x15,0x20,0xcd,0xfd,0xa5,0x23,0x29,0x07,0x85,0x69,0xa2,0x07,0xb5,0x09,
	0x29,0x07,0xc5,0x69,0xf0,0x5c,0xca,0x10,0xf5,0xa6,0x22,0xf0,0x55,0xe0,0x05,0x10,
	0x51,0xb5,0x00,0x29,0x07,0xc5,0x69,0xf0,0x2a,0xa2,0x07,0xb5,0x1a,0x29,0x07,0xc5,
	0x69,0xf0,0x20,0xca,0x10,0xf5,0xa6,0x22,0xe0,0x03,0x30,0x17,0xa5,0x11,0x29,0x0f,
	0xc5,0x69,0xd0,0x0f,0xa5,0x13,0x29,0x0f,0xc5,0x69,0xd0,0x07,0xa5,0x25,0x18,0x69,
	0x0a,0x85,0x25,0xa9,0x20,0x20,0xcd,0xfd,0xa2,0x04,0xb5,0x00,0x29,0x07,0xc5,0x69,
	0xd0,0x06,0xe4,0x22,0xf0,0x02,0xd0,0x05,0xca,0x10,0xef,0x30,0x05,0xa9,0x10,0x20,
	0xcd,0xfd,0xa5,0x22,0xf0,0x11,0xc9,0x05,0x10,0x0d,0xa5,0x23,0x29,0x60,0xc9,0x60,
	0xd0,0x05,0xa9,0x18,0x20,0xcd,0xfd,0xa5,0x22,0xf0,0x0d,0xc9,0x09,0x10,0x09,0xa5,
	0x11,0x20,0xe9,0xfd,0x0a,0x20,0xd9,0xfd,0xa5,0x22,0xc9,0x03,0xf0,0x04,0xc9,0x04,
	0xd0,0x3a,0xa5,0x25,0xc9,0x80,0x30,0x34,0xc9,0x82,0x10,0x30,0xa5,0x40,0xd0,0x2c,
	0xa5,0x31,0xc9,0x05,0x10,0x26,0xa5,0x23,0xc9,0x01,0xd0,0x02,0x85,0x6f,0xc9,0x02,
	0xd0,0x02,0x85,0x6e,0xc9,0x06,0xd0,0x02,0x85,0x6d,0xc9,0x05,0xd0,0x02,0x85,0x6c,
	0xc9,0x04,0xd0,0x02,0x85,0x6b,0xc9,0x03,0xd0,0x02,0x85,0x6a,0xa6,0x22,0xe0,0x02,
	0xd0,0x14,0xa6,0x60,0xe0,0x05,0x10,0x05,0xa9,0x20,0x20,0xd9,0xfd,0xe0,0x09,0x10,
	0x05,0xa9,0x08,0x20,0xd9,0xfd,0xa6,0x22,0xe0,0x07,0xf0,0x04,0xe0,0x08,0xd0,0x1e,
	0xa5,0x23,0x29,0x0f,0xc9,0x00,0xf0,0x04,0xc9,0x07,0xd0,0x05,0xa9,0x10,0x20,0xd9,
	0xfd,0xb5,0x00,0x29,0x70,0xc9,0x00,0xd0,0x05,0xa9,0x08,0x20,0xcd,0xfd,0xa6,0x22,
	0xd0,0x48,0x20,0x17,0xfe,0x48,0xa5,0x23,0x48,0xa5,0x00,0x85,0x23,0x20,0x17,0xfe,
	0x68,0x85,0x23,0x68,0x38,0xe5,0x51,0xb0,0x07,0x49,0xff,0x0a,0x0a,0x20,0xcd,0xfd,
	0xa2,0x09,0xa9,0x00,0x18,0xb4,0x11,0x30,0x03,0x7d,0x30,0xfe,0xca,0xd0,0xf6,0xc9,
	0x10,0x10,0x12,0xa9,0x44,0x20,0xe9,0xfd,0x85,0x51,0xa9,0x20,0x38,0xe5,0x51,0x20,
	0xcd,0xfd,0x4c,0x6a,0xfd,0xa9,0x30,0x20,0xd9,0xfd,0xa5,0x30,0xc9,0x03,0xb0,0x1b,
	0xa9,0xfd,0x85,0x4c,0xa9,0x05,0x85,0x24,0xa5,0x39,0x48,0x20,0xa8,0xf7,0x68,0x85,
	0x39,0xa5,0x4c,0xc9,0xff,0xd0,0x04,0xa9,0xf0,0x85,0x25,0xa2,0x04,0x86,0x24,0xa5,
	0x25,0xc5,0x27,0x90,0x27,0xd0,0x08,0xa5,0x26,0xc5,0x28,0x90,0x1f,0xf0,0x1d,0xa5,
	0x25,0x85,0x27,0xa5,0x26,0x85,0x28,0xa5,0x22,0x85,0x29,0xa5,0x23,0x85,0x2a,0xa5,
	0x39,0x85,0x79,0xa5,0x27,0xc9,0xff,0xd0,0x03,0x4c,0x4e,0xf4,0xa9,0x00,0x85,0x8a,
	0x85,0x52,0x85,0x50,0x85,0x46,0xa9,0x05,0x85,0x53,0x4c,0x7b,0xff,0x18,0x65,0x26,
	0x85,0x26,0xa5,0x25,0x69,0x00,0x85,0x25,0x60,0x38,0x85,0x69,0xa5,0x26,0xe5,0x69,
	0x85,0x26,0xa5,0x25,0xe9,0x00,0x85,0x25,0x60,0x48,0x4a,0x4a,0x4a,0x4a,0x85,0x69,
	0xa5,0x23,0x4a,0x4a,0x4a,0x4a,0x38,0xe5,0x69,0xb0,0x04,0x49,0xff,0x69,0x01,0x85,
	0x69,0x68,0x29,0x07,0x85,0x68,0xa5,0x23,0x29,0x07,0x38,0xe5,0x68,0xb0,0x04,0x49,
	0xff,0x69,0x01,0x18,0x65,0x69,0x60,0xa9,0x00,0x85,0x51,0xa2,0x08,0xb5,0x09,0x30,
	0x08,0x20,0xe9,0xfd,0x18,0x65,0x51,0x85,0x51,0xca,0xd0,0xf1,0xa5,0x51,0x60,0x00,
	0x13,0x12,0x12,0x0a,0x0a,0x06,0x06,0x05,0x05,0x02,0x02,0x02,0x02,0x02,0x02,0x02,
	0x02,0x00,0xf0,0xff,0x01,0x10,0x11,0x0f,0xef,0xf1,0xdf,0xe1,0xee,0xf2,0x12,0x0e,
	0x1f,0x21,0x03,0xcc,0x04,0x00,0x07,0x02,0x05,0x01,0x06,0x10,0x17,0x11,0x16,0x12,
	0x15,0x14,0x13,0x73,0xcc,0x74,0x70,0x77,0x72,0x75,0x71,0x76,0x60,0x67,0x61,0x66,
	0x62,0x65,0x64,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,0x00,
	0x08,0x08,0x08,0x08,0xff,0xfd,0xfc,0xfb,0xfb,0xfb,0xfb,0xfb,0x55,0x55,0x55,0x55,
	0x55,0x55,0x55,0x00,0x09,0x08,0x08,0x05,0x05,0x03,0x03,0x02,0x02,0x01,0x01,0x01,
	0x01,0x01,0x01,0x01,0x01,0xf9,0xf8,0xf8,0xf5,0xf5,0xf3,0xf3,0xf2,0xf2,0xf1,0xf1,
	0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xa9,0xff,0x8d,0x01,0x8b,0xa6,0x78,0xa5,0x83,0x20,
	0xc4,0xfe,0xa5,0x84,0x48,0x4a,0x4a,0x4a,0x4a,0x24,0x7f,0x10,0x05,0x20,0xe0,0xfe,
	0xf0,0x03,0x20,0xe3,0xfe,0x68,0x29,0x0f,0x24,0x7f,0x30,0x04,0x29,0x0f,0xf0,0x07,
	0x18,0x69,0x10,0xa8,0xb9,0xc6,0xff,0x24,0x78,0x30,0x03,0x29,0x7f,0x2c,0x09,0x80,
	0xa0,0x00,0x8c,0x00,0x8b,0x8e,0x02,0x8b,0x8d,0x00,0x8b,0xe8,0xa0,0x7f,0x88,0xd0,
	0xfd,0x60,0x38,0x24,0x18,0x66,0x7f,0x20,0x80,0xff,0x20,0x40,0xff,0xc5,0x80,0xf0,
	0xf6,0x85,0x80,0xc9,0x00,0xf0,0xf0,0xc6,0x8b,0x20,0x9f,0xff,0x0a,0x46,0x8b,0x46,
	0x8b,0xd0,0xf6,0xa5,0x80,0x60,0x48,0x4a,0x4a,0x4a,0x4a,0x20,0x31,0xff,0x68,0x29,
	0x0f,0x20,0x17,0xff,0x98,0x48,0xa0,0x40,0x20,0x7d,0xff,0x88,0xd0,0xfa,0xf0,0x36,
	0x98,0x48,0x8a,0x48,0xa9,0x80,0x8d,0x01,0x8b,0xa2,0xff,0xad,0x00,0x8b,0xcd,0x00,
	0x8b,0xd0,0xf8,0x09,0x80,0x49,0xff,0xd0,0x0b,0xe0,0x06,0xf0,0x0e,0xee,0x02,0x8b,
	0xa2,0x06,0xd0,0xe7,0x0a,0xb0,0x03,0xe8,0x10,0xfa,0x8a,0x85,0x69,0xa9,0x04,0x05,
	0x78,0x8d,0x02,0x8b,0x68,0xaa,0x68,0xa8,0xa5,0x69,0x60,0x38,0x24,0x18,0x66,0x7f,
	0x98,0x48,0x8a,0x48,0x24,0x7f,0x10,0x08,0xa5,0x7c,0x85,0x83,0xa5,0x7d,0x85,0x84,
	0x20,0xb6,0xfe,0xf0,0xd8,0xa9,0x10,0x20,0x9c,0xff,0xa9,0x08,0x20,0x9f,0xff,0x85,
	0x69,0x98,0x48,0x8a,0x48,0xa9,0x06,0x05,0x78,0x8d,0x02,0x8b,0xa0,0x08,0xa5,0x69,
	0x18,0x65,0x69,0x48,0x2a,0x29,0x01,0x4d,0x02,0x8b,0x8d,0x02,0x8b,0x68,0xca,0xd0,
	0xef,0x88,0xd0,0xec,0xf0,0xa7,0x00,0x77,0x7c,0x39,0x5e,0x79,0x71,0x3d,0x76,0x00,
	0x53,0x00,0x00,0x40,0x08,0x40,0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,
	0x53,0x00,0x00,0x40,0x08,0x00,0x00,0x00,0x43,0x48,0x45,0x53,0x53,0x4d,0x41,0x54,
	0x45,0x20,0x37,0x2e,0x35,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x4c,0xf3
};
uint8_t RRIOT_RAM[RRIOT_RAM_SIZE];

uint8_t read6502(uint16_t address) {
  uint16_t PGMaddr;

  // Main program?
  if (address >= CHESSMATE_ROM) {
    PGMaddr = address - CHESSMATE_ROM;
	  return(pgm_read_byte_near(CHESSMATE + PGMaddr));
  }

  // RAM memory.
  if (address < RAM_SIZE) return(RAM[address]);

  // Check for RRIOT registers.
  if (address >= RRIOT_REGISTERS && address < (RRIOT_REGISTERS + RRIOT_REG_SIZE)) {
	  PGMaddr = address - RRIOT_REGISTERS;
	  return readRRIOT(PGMaddr);
  }

  // Check for RRIOT RAM.
  if (address >= RRIOT_RAM_ADDR && address < (RRIOT_RAM_ADDR + RRIOT_RAM_SIZE)) {
	  PGMaddr = address - RRIOT_RAM_ADDR;
  	return(RRIOT_RAM[PGMaddr]);
  }

  // Not a valid memory location.
  return(0);
}

void write6502(uint16_t address, uint8_t value) {
  uint16_t PGMaddr;

  if (address < RAM_SIZE) RAM[address] = value;

  // Check for RRIOT registers.
  if (address >= RRIOT_REGISTERS && address < (RRIOT_REGISTERS + RRIOT_REG_SIZE)) {
	  PGMaddr = address - RRIOT_REGISTERS;
	  writeRRIOT(PGMaddr, value);
  }

  // Check for RRIOT RAM.
  if (address >= RRIOT_RAM_ADDR && address < (RRIOT_RAM_ADDR + RRIOT_RAM_SIZE)) {
  	  PGMaddr = address - RRIOT_RAM_ADDR;
      RRIOT_RAM[PGMaddr] = value;
  }
}

//a few general functions used by various other functions
void push16(uint16_t pushval) {
    write6502(BASE_STACK + sp, (pushval >> 8) & 0xFF);
    write6502(BASE_STACK + ((sp - 1) & 0xFF), pushval & 0xFF);
    sp -= 2;
}

void push8(uint8_t pushval) {
    write6502(BASE_STACK + sp--, pushval);
}

uint16_t pull16() {
    uint16_t temp16;
    temp16 = read6502(BASE_STACK + ((sp + 1) & 0xFF)) | ((uint16_t)read6502(BASE_STACK + ((sp + 2) & 0xFF)) << 8);
    sp += 2;
    return(temp16);
}

uint8_t pull8() {
    return (read6502(BASE_STACK + ++sp));
}

void reset6502() {
    pc = (uint16_t)read6502(0xFFFC) | ((uint16_t)read6502(0xFFFD) << 8);
    a = 0;
    x = 0;
    y = 0;
    sp = 0xFD;
    cpustatus |= FLAG_CONSTANT;
}

//addressing mode functions, calculates effective addresses
void imp() { //implied
}

void acc() { //accumulator
  useaccum = 1;
}

void imm() { //immediate
    ea = pc++;
}

void zp() { //zero-page
    ea = (uint16_t)read6502((uint16_t)pc++);
}

void zpx() { //zero-page,X
    ea = ((uint16_t)read6502((uint16_t)pc++) + (uint16_t)x) & 0xFF; //zero-page wraparound
}

void zpy() { //zero-page,Y
    ea = ((uint16_t)read6502((uint16_t)pc++) + (uint16_t)y) & 0xFF; //zero-page wraparound
}

void rel() { //relative for branch ops (8-bit immediate value, sign-extended)
    reladdr = (uint16_t)read6502(pc++);
    if (reladdr & 0x80) reladdr |= 0xFF00;
}

void abso() { //absolute
    ea = (uint16_t)read6502(pc) | ((uint16_t)read6502(pc+1) << 8);
    pc += 2;
}

void absx() { //absolute,X
    uint16_t startpage;
    ea = ((uint16_t)read6502(pc) | ((uint16_t)read6502(pc+1) << 8));
    startpage = ea & 0xFF00;
    ea += (uint16_t)x;

    pc += 2;
}

void absy() { //absolute,Y
    uint16_t startpage;
    ea = ((uint16_t)read6502(pc) | ((uint16_t)read6502(pc+1) << 8));
    startpage = ea & 0xFF00;
    ea += (uint16_t)y;

    pc += 2;
}

void ind() { //indirect
    uint16_t eahelp, eahelp2;
    eahelp = (uint16_t)read6502(pc) | (uint16_t)((uint16_t)read6502(pc+1) << 8);
    eahelp2 = (eahelp & 0xFF00) | ((eahelp + 1) & 0x00FF); //replicate 6502 page-boundary wraparound bug
    ea = (uint16_t)read6502(eahelp) | ((uint16_t)read6502(eahelp2) << 8);
    pc += 2;
}

void indx() { // (indirect,X)
    uint16_t eahelp;
    eahelp = (uint16_t)(((uint16_t)read6502(pc++) + (uint16_t)x) & 0xFF); //zero-page wraparound for table pointer
    ea = (uint16_t)read6502(eahelp & 0x00FF) | ((uint16_t)read6502((eahelp+1) & 0x00FF) << 8);
}

void indy() { // (indirect),Y
    uint16_t eahelp, eahelp2, startpage;
    eahelp = (uint16_t)read6502(pc++);
    eahelp2 = (eahelp & 0xFF00) | ((eahelp + 1) & 0x00FF); //zero-page wraparound
    ea = (uint16_t)read6502(eahelp) | ((uint16_t)read6502(eahelp2) << 8);
    startpage = ea & 0xFF00;
    ea += (uint16_t)y;

}

static uint16_t getvalue() {
    if (useaccum) return((uint16_t)a);
        else return((uint16_t)read6502(ea));
}

static uint16_t getvalue16() {
    return((uint16_t)read6502(ea) | ((uint16_t)read6502(ea+1) << 8));
}

void putvalue(uint16_t saveval) {
    if (useaccum) a = (uint8_t)(saveval & 0x00FF);
        else write6502(ea, (saveval & 0x00FF));
}


//instruction handler functions
void adc() {
    value = getvalue();
    result = (uint16_t)a + value + (uint16_t)(cpustatus & FLAG_CARRY);

    carrycalc(result);
    zerocalc(result);
    overflowcalc(result, a, value);
    signcalc(result);

    #ifndef NES_CPU
    if (cpustatus & FLAG_DECIMAL) {
        clearcarry();

        if ((a & 0x0F) > 0x09) {
            a += 0x06;
        }
        if ((a & 0xF0) > 0x90) {
            a += 0x60;
            setcarry();
        }

        clockticks6502++;
    }
    #endif

    saveaccum(result);
}

void op_and() {
    value = getvalue();
    result = (uint16_t)a & value;

    zerocalc(result);
    signcalc(result);

    saveaccum(result);
}

void asl() {
    value = getvalue();
    result = value << 1;

    carrycalc(result);
    zerocalc(result);
    signcalc(result);

    putvalue(result);
}

void bcc() {
    if ((cpustatus & FLAG_CARRY) == 0) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void bcs() {
    if ((cpustatus & FLAG_CARRY) == FLAG_CARRY) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void beq() {
    if ((cpustatus & FLAG_ZERO) == FLAG_ZERO) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void op_bit() {
    value = getvalue();
    result = (uint16_t)a & value;

    zerocalc(result);
    cpustatus = (cpustatus & 0x3F) | (uint8_t)(value & 0xC0);
}

void bmi() {
    if ((cpustatus & FLAG_SIGN) == FLAG_SIGN) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void bne() {
    if ((cpustatus & FLAG_ZERO) == 0) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void bpl() {
    if ((cpustatus & FLAG_SIGN) == 0) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void brk() {
    pc++;
    push16(pc); //push next instruction address onto stack
    push8(cpustatus | FLAG_BREAK); //push CPU cpustatus to stack
    setinterrupt(); //set interrupt flag
    pc = (uint16_t)read6502(0xFFFE) | ((uint16_t)read6502(0xFFFF) << 8);
}

void bvc() {
    if ((cpustatus & FLAG_OVERFLOW) == 0) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void bvs() {
    if ((cpustatus & FLAG_OVERFLOW) == FLAG_OVERFLOW) {
        oldpc = pc;
        pc += reladdr;
        if ((oldpc & 0xFF00) != (pc & 0xFF00)) clockticks6502 += 2; //check if jump crossed a page boundary
            else clockticks6502++;
    }
}

void clc() {
    clearcarry();
}

void cld() {
    cleardecimal();
}

void cli() {
    clearinterrupt();
}

void clv() {
    clearoverflow();
}

void cmp() {
    value = getvalue();
    result = (uint16_t)a - value;

    if (a >= (uint8_t)(value & 0x00FF)) setcarry();
        else clearcarry();
    if (a == (uint8_t)(value & 0x00FF)) setzero();
        else clearzero();
    signcalc(result);
}

void cpx() {
    value = getvalue();
    result = (uint16_t)x - value;

    if (x >= (uint8_t)(value & 0x00FF)) setcarry();
        else clearcarry();
    if (x == (uint8_t)(value & 0x00FF)) setzero();
        else clearzero();
    signcalc(result);
}

void cpy() {
    value = getvalue();
    result = (uint16_t)y - value;

    if (y >= (uint8_t)(value & 0x00FF)) setcarry();
        else clearcarry();
    if (y == (uint8_t)(value & 0x00FF)) setzero();
        else clearzero();
    signcalc(result);
}

void dec() {
    value = getvalue();
    result = value - 1;

    zerocalc(result);
    signcalc(result);

    putvalue(result);
}

void dex() {
    x--;

    zerocalc(x);
    signcalc(x);
}

void dey() {
    y--;

    zerocalc(y);
    signcalc(y);
}

void eor() {
    value = getvalue();
    result = (uint16_t)a ^ value;

    zerocalc(result);
    signcalc(result);

    saveaccum(result);
}

void inc() {
    value = getvalue();
    result = value + 1;

    zerocalc(result);
    signcalc(result);

    putvalue(result);
}

void inx() {
    x++;

    zerocalc(x);
    signcalc(x);
}

void iny() {
    y++;

    zerocalc(y);
    signcalc(y);
}

void jmp() {
    pc = ea;
}

void jsr() {
    push16(pc - 1);
    pc = ea;
}

void lda() {
    value = getvalue();
    a = (uint8_t)(value & 0x00FF);

    zerocalc(a);
    signcalc(a);
}

void ldx() {
    value = getvalue();
    x = (uint8_t)(value & 0x00FF);

    zerocalc(x);
    signcalc(x);
}

void ldy() {
    value = getvalue();
    y = (uint8_t)(value & 0x00FF);

    zerocalc(y);
    signcalc(y);
}

void lsr() {
    value = getvalue();
    result = value >> 1;

    if (value & 1) setcarry();
        else clearcarry();
    zerocalc(result);
    signcalc(result);

    putvalue(result);
}

void nop() {
}

void ora() {
    value = getvalue();
    result = (uint16_t)a | value;

    zerocalc(result);
    signcalc(result);

    saveaccum(result);
}

void pha() {
    push8(a);
}

void php() {
    push8(cpustatus | FLAG_BREAK);
}

void pla() {
    a = pull8();

    zerocalc(a);
    signcalc(a);
}

void plp() {
    cpustatus = pull8() | FLAG_CONSTANT;
}

void rol() {
    value = getvalue();
    result = (value << 1) | (cpustatus & FLAG_CARRY);

    carrycalc(result);
    zerocalc(result);
    signcalc(result);

    putvalue(result);
}

void ror() {
    value = getvalue();
    result = (value >> 1) | ((cpustatus & FLAG_CARRY) << 7);

    if (value & 1) setcarry();
        else clearcarry();
    zerocalc(result);
    signcalc(result);

    putvalue(result);
}

void rti() {
    cpustatus = pull8();
    value = pull16();
    pc = value;
}

void rts() {
    value = pull16();
    pc = value + 1;
}

void sbc() {
    value = getvalue() ^ 0x00FF;
    result = (uint16_t)a + value + (uint16_t)(cpustatus & FLAG_CARRY);

    carrycalc(result);
    zerocalc(result);
    overflowcalc(result, a, value);
    signcalc(result);

    #ifndef NES_CPU
    if (cpustatus & FLAG_DECIMAL) {
        clearcarry();

        a -= 0x66;
        if ((a & 0x0F) > 0x09) {
            a += 0x06;
        }
        if ((a & 0xF0) > 0x90) {
            a += 0x60;
            setcarry();
        }

        clockticks6502++;
    }
    #endif

    saveaccum(result);
}

void sec() {
    setcarry();
}

void sed() {
    setdecimal();
}

void sei() {
    setinterrupt();
}

void sta() {
    putvalue(a);
}

void stx() {
    putvalue(x);
}

void sty() {
    putvalue(y);
}

void tax() {
    x = a;

    zerocalc(x);
    signcalc(x);
}

void tay() {
    y = a;

    zerocalc(y);
    signcalc(y);
}

void tsx() {
    x = sp;

    zerocalc(x);
    signcalc(x);
}

void txa() {
    a = x;

    zerocalc(a);
    signcalc(a);
}

void txs() {
    sp = x;
}

void tya() {
    a = y;

    zerocalc(a);
    signcalc(a);
}

//undocumented instructions
#ifdef UNDOCUMENTED
    void lax() {
        lda();
        ldx();
    }

    void sax() {
        sta();
        stx();
        putvalue(a & x);
    }

    void dcp() {
        dec();
        cmp();
    }

    void isb() {
        inc();
        sbc();
    }

    void slo() {
        asl();
        ora();
    }

    void rla() {
        rol();
        op_and();
    }

    void sre() {
        lsr();
        eor();
    }

    void rra() {
        ror();
        adc();
    }
#else
    #define lax nop
    #define sax nop
    #define dcp nop
    #define isb nop
    #define slo nop
    #define rla nop
    #define sre nop
    #define rra nop
#endif


void nmi6502() {
    push16(pc);
    push8(cpustatus);
    cpustatus |= FLAG_INTERRUPT;
    pc = (uint16_t)read6502(0xFFFA) | ((uint16_t)read6502(0xFFFB) << 8);
}

void irq6502() {
    push16(pc);
    push8(cpustatus);
    cpustatus |= FLAG_INTERRUPT;
    pc = (uint16_t)read6502(0xFFFE) | ((uint16_t)read6502(0xFFFF) << 8);
}

#ifdef USE_TIMING
PGM_P const ticktable[256] PROGMEM = {
/*        |  0  |  1  |  2  |  3  |  4  |  5  |  6  |  7  |  8  |  9  |  A  |  B  |  C  |  D  |  E  |  F  |     */
/* 0 */      7,    6,    2,    8,    3,    3,    5,    5,    3,    2,    2,    2,    4,    4,    6,    6,  /* 0 */
/* 1 */      2,    5,    2,    8,    4,    4,    6,    6,    2,    4,    2,    7,    4,    4,    7,    7,  /* 1 */
/* 2 */      6,    6,    2,    8,    3,    3,    5,    5,    4,    2,    2,    2,    4,    4,    6,    6,  /* 2 */
/* 3 */      2,    5,    2,    8,    4,    4,    6,    6,    2,    4,    2,    7,    4,    4,    7,    7,  /* 3 */
/* 4 */      6,    6,    2,    8,    3,    3,    5,    5,    3,    2,    2,    2,    3,    4,    6,    6,  /* 4 */
/* 5 */      2,    5,    2,    8,    4,    4,    6,    6,    2,    4,    2,    7,    4,    4,    7,    7,  /* 5 */
/* 6 */      6,    6,    2,    8,    3,    3,    5,    5,    4,    2,    2,    2,    5,    4,    6,    6,  /* 6 */
/* 7 */      2,    5,    2,    8,    4,    4,    6,    6,    2,    4,    2,    7,    4,    4,    7,    7,  /* 7 */
/* 8 */      2,    6,    2,    6,    3,    3,    3,    3,    2,    2,    2,    2,    4,    4,    4,    4,  /* 8 */
/* 9 */      2,    6,    2,    6,    4,    4,    4,    4,    2,    5,    2,    5,    5,    5,    5,    5,  /* 9 */
/* A */      2,    6,    2,    6,    3,    3,    3,    3,    2,    2,    2,    2,    4,    4,    4,    4,  /* A */
/* B */      2,    5,    2,    5,    4,    4,    4,    4,    2,    4,    2,    4,    4,    4,    4,    4,  /* B */
/* C */      2,    6,    2,    8,    3,    3,    5,    5,    2,    2,    2,    2,    4,    4,    6,    6,  /* C */
/* D */      2,    5,    2,    8,    4,    4,    6,    6,    2,    4,    2,    7,    4,    4,    7,    7,  /* D */
/* E */      2,    6,    2,    8,    3,    3,    5,    5,    2,    2,    2,    2,    4,    4,    6,    6,  /* E */
/* F */      2,    5,    2,    8,    4,    4,    6,    6,    2,    4,    2,    7,    4,    4,    7,    7   /* F */
};
#endif

void exec6502(int32_t tickcount) {
#ifdef USE_TIMING
  clockgoal6502 += tickcount;

  while (clockgoal6502 > 0) {
#else
  while (tickcount--) {
#endif
    opcode = read6502(pc++);
    cpustatus |= FLAG_CONSTANT;

    useaccum = 0;

		switch (opcode) {
		case 0x0:
			imp();
			brk();
			break;
		case 0x1:
			indx();
			ora();
			break;
		case 0x5:
			zp();
			ora();
			break;
		case 0x6:
			zp();
			asl();
			break;
		case 0x8:
			imp();
			php();
			break;
		case 0x9:
			imm();
			ora();
			break;
		case 0xA:
			acc();
			asl();
			break;
		case 0xD:
			abso();
			ora();
			break;
		case 0xE:
			abso();
			asl();
			break;
		case 0x10:
			rel();
			bpl();
			break;
		case 0x11:
			indy();
			ora();
			break;
		case 0x15:
			zpx();
			ora();
			break;
		case 0x16:
			zpx();
			asl();
			break;
		case 0x18:
			imp();
			clc();
			break;
		case 0x19:
			absy();
			ora();
			break;
		case 0x1D:
			absx();
			ora();
			break;
		case 0x1E:
			absx();
			asl();
			break;
		case 0x20:
			abso();
			jsr();
			break;
		case 0x21:
			indx();
			op_and();
			break;
		case 0x24:
			zp();
			op_bit();
			break;
		case 0x25:
			zp();
			op_and();
			break;
		case 0x26:
			zp();
			rol();
			break;
		case 0x28:
			imp();
			plp();
			break;
		case 0x29:
			imm();
			op_and();
			break;
		case 0x2A:
			acc();
			rol();
			break;
		case 0x2C:
			abso();
			op_bit();
			break;
		case 0x2D:
			abso();
			op_and();
			break;
		case 0x2E:
			abso();
			rol();
			break;
		case 0x30:
			rel();
			bmi();
			break;
		case 0x31:
			indy();
			op_and();
			break;
		case 0x35:
			zpx();
			op_and();
			break;
		case 0x36:
			zpx();
			rol();
			break;
		case 0x38:
			imp();
			sec();
			break;
		case 0x39:
			absy();
			op_and();
			break;
		case 0x3D:
			absx();
			op_and();
			break;
		case 0x3E:
			absx();
			rol();
			break;
		case 0x40:
			imp();
			rti();
			break;
		case 0x41:
			indx();
			eor();
			break;
		case 0x45:
			zp();
			eor();
			break;
		case 0x46:
			zp();
			lsr();
			break;
		case 0x48:
			imp();
			pha();
			break;
		case 0x49:
			imm();
			eor();
			break;
		case 0x4A:
			acc();
			lsr();
			break;
		case 0x4C:
			abso();
			jmp();
			break;
		case 0x4D:
			abso();
			eor();
			break;
		case 0x4E:
			abso();
			lsr();
			break;
		case 0x50:
			rel();
			bvc();
			break;
		case 0x51:
			indy();
			eor();
			break;
		case 0x55:
			zpx();
			eor();
			break;
		case 0x56:
			zpx();
			lsr();
			break;
		case 0x58:
			imp();
			cli();
			break;
		case 0x59:
			absy();
			eor();
			break;
		case 0x5D:
			absx();
			eor();
			break;
		case 0x5E:
			absx();
			lsr();
			break;
		case 0x60:
			imp();
			rts();
			break;
		case 0x61:
			indx();
			adc();
			break;
		case 0x65:
			zp();
			adc();
			break;
		case 0x66:
			zp();
			ror();
			break;
		case 0x68:
			imp();
			pla();
			break;
		case 0x69:
			imm();
			adc();
			break;
		case 0x6A:
			acc();
			ror();
			break;
		case 0x6C:
			ind();
			jmp();
			break;
		case 0x6D:
			abso();
			adc();
			break;
		case 0x6E:
			abso();
			ror();
			break;
		case 0x70:
			rel();
			bvs();
			break;
		case 0x71:
			indy();
			adc();
			break;
		case 0x75:
			zpx();
			adc();
			break;
		case 0x76:
			zpx();
			ror();
			break;
		case 0x78:
			imp();
			sei();
			break;
		case 0x79:
			absy();
			adc();
			break;
		case 0x7D:
			absx();
			adc();
			break;
		case 0x7E:
			absx();
			ror();
			break;
		case 0x81:
			indx();
			sta();
			break;
		case 0x84:
			zp();
			sty();
			break;
		case 0x85:
			zp();
			sta();
			break;
		case 0x86:
			zp();
			stx();
			break;
		case 0x88:
			imp();
			dey();
			break;
		case 0x8A:
			imp();
			txa();
			break;
		case 0x8C:
			abso();
			sty();
			break;
		case 0x8D:
			abso();
			sta();
			break;
		case 0x8E:
			abso();
			stx();
			break;
		case 0x90:
			rel();
			bcc();
			break;
		case 0x91:
			indy();
			sta();
			break;
		case 0x94:
			zpx();
			sty();
			break;
		case 0x95:
			zpx();
			sta();
			break;
		case 0x96:
			zpy();
			stx();
			break;
		case 0x98:
			imp();
			tya();
			break;
		case 0x99:
			absy();
			sta();
			break;
		case 0x9A:
			imp();
			txs();
			break;
		case 0x9D:
			absx();
			sta();
			break;
		case 0xA0:
			imm();
			ldy();
			break;
		case 0xA1:
			indx();
			lda();
			break;
		case 0xA2:
			imm();
			ldx();
			break;
		case 0xA4:
			zp();
			ldy();
			break;
		case 0xA5:
			zp();
			lda();
			break;
		case 0xA6:
			zp();
			ldx();
			break;
		case 0xA8:
			imp();
			tay();
			break;
		case 0xA9:
			imm();
			lda();
			break;
		case 0xAA:
			imp();
			tax();
			break;
		case 0xAC:
			abso();
			ldy();
			break;
		case 0xAD:
			abso();
			lda();
			break;
		case 0xAE:
			abso();
			ldx();
			break;
		case 0xB0:
			rel();
			bcs();
			break;
		case 0xB1:
			indy();
			lda();
			break;
		case 0xB4:
			zpx();
			ldy();
			break;
		case 0xB5:
			zpx();
			lda();
			break;
		case 0xB6:
			zpy();
			ldx();
			break;
		case 0xB8:
			imp();
			clv();
			break;
		case 0xB9:
			absy();
			lda();
			break;
		case 0xBA:
			imp();
			tsx();
			break;
		case 0xBC:
			absx();
			ldy();
			break;
		case 0xBD:
			absx();
			lda();
			break;
		case 0xBE:
			absy();
			ldx();
			break;
		case 0xC0:
			imm();
			cpy();
			break;
		case 0xC1:
			indx();
			cmp();
			break;
		case 0xC4:
			zp();
			cpy();
			break;
		case 0xC5:
			zp();
			cmp();
			break;
		case 0xC6:
			zp();
			dec();
			break;
		case 0xC8:
			imp();
			iny();
			break;
		case 0xC9:
			imm();
			cmp();
			break;
		case 0xCA:
			imp();
			dex();
			break;
		case 0xCC:
			abso();
			cpy();
			break;
		case 0xCD:
			abso();
			cmp();
			break;
		case 0xCE:
			abso();
			dec();
			break;
		case 0xD0:
			rel();
			bne();
			break;
		case 0xD1:
			indy();
			cmp();
			break;
		case 0xD5:
			zpx();
			cmp();
			break;
		case 0xD6:
			zpx();
			dec();
			break;
		case 0xD8:
			imp();
			cld();
			break;
		case 0xD9:
			absy();
			cmp();
			break;
		case 0xDD:
			absx();
			cmp();
			break;
		case 0xDE:
			absx();
			dec();
			break;
		case 0xE0:
			imm();
			cpx();
			break;
		case 0xE1:
			indx();
			sbc();
			break;
		case 0xE4:
			zp();
			cpx();
			break;
		case 0xE5:
			zp();
			sbc();
			break;
		case 0xE6:
			zp();
			inc();
			break;
		case 0xE8:
			imp();
			inx();
			break;
		case 0xE9:
			imm();
			sbc();
			break;
		case 0xEB:
			imm();
			sbc();
			break;
		case 0xEC:
			abso();
			cpx();
			break;
		case 0xED:
			abso();
			sbc();
			break;
		case 0xEE:
			abso();
			inc();
			break;
		case 0xF0:
			rel();
			beq();
			break;
		case 0xF1:
			indy();
			sbc();
			break;
		case 0xF5:
			zpx();
			sbc();
			break;
		case 0xF6:
			zpx();
			inc();
			break;
		case 0xF8:
			imp();
			sed();
			break;
		case 0xF9:
			absy();
			sbc();
			break;
		case 0xFD:
			absx();
			sbc();
			break;
		case 0xFE:
			absx();
			inc();
			break;
		}
#ifdef USE_TIMING
      clockgoal6502 -= (int32_t)pgm_read_byte_near(ticktable + opcode);
#endif
      instructions++;
  }
}

uint16_t getpc() {
  return(pc);
}

uint8_t getop() {
  return(opcode);
}
